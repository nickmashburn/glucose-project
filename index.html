<!DOCTYPE html>
<html>
 <head>
    
  <title>A1C History</title>
   <script src="fhir-client.js"></script>
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  </head>
  <body>

    <h1 id="status">Retrieving Glucose Data...</h1>
    <div id="glucose-chart" style="width:800px;height:400px;"></div>
    <div id="a1c-chart" style="width:800px;height:400px;">I hope this one is!</div>
    
    <script>
      
      
      FHIR.oauth2.ready( getA1cdata, showError );
      
      var statusDiv =  document.getElementById("status");
      var a1cChartDiv = document.getElementById("a1c-chart");

      function getA1cdata(smart) {
        
        smart.patient.api.search({
          type: "Observation", 
          query: {
            code: "4548-4", 
            "_sort:desc": "date", 
            _count: 10
          }
          
        }).then( function(fhirObservations) {

          var dates = [];
          var values = [];            
          
          (fhirObservations.data.entry || []).forEach( function(a1c) {
            var date = a1c.resource.effectiveDateTime;
            var value = a1c.resource.valueQuantity && a1c.resource.valueQuantity.value;
            if (date && value && dates.indexOf(date) == -1) {
              dates.push(date);
              values.push(Math.round(value*10)/10);
            };
          });
          
          if (values.length === 0)
            return statusDiv.innerHTML = "No A1c observations found.";
          
          statusDiv.style.display = "none";

          Plotly.newPlot(a1cChartDiv, {
            data: [{
              x: dates,
              y: values,
              type: "scatter"
            }],
            layout: {
              title: "A1c Lab Values",
              xaxis: {type: "date", tickformat: "%b %y"},
              yaxis: {range: [0, 10]}
            },
            config: {
              displayModeBar: false
            }
          });          
        });
        
      }
      FHIR.oauth2.ready( getGlucosedata, showError );
      
      var statusDiv =  document.getElementById("status");
      var glucoseChartDiv = document.getElementById("glucose-chart");
      
      function getGlucosedata(smart) {
        
        smart.patient.api.search({
          type: "Observation", 
          query: {
            code: "2339-0", 
            "_sort:desc": "date", 
            _count: 10
          }
          
        }).then( function(fhirObservations) {

          var dates = [];
          var values = [];            
          
          (fhirObservations.data.entry || []).forEach( function(glucose) {
            var date = glucose.resource.effectiveDateTime;
            var value = glucose.resource.valueQuantity && glucose.resource.valueQuantity.value;
            if (date && value && dates.indexOf(date) == -1) {
              dates.push(date);
              values.push(Math.round(value*10)/10);
            };
          });
          
          if (values.length === 0)
            return statusDiv.innerHTML = "No Blood Glucose observations found.";
          
          statusDiv.style.display = "none";

          Plotly.newPlot(glucoseChartDiv, {
            data: [{
              x: dates,
              y: values,
              type: "scatter"
            }],
            layout: {
              title: "Blood Glucose Lab Values",
              xaxis: {type: "date", tickformat: "%b %y"},
              yaxis: {range: [0, 200]}
            },
            config: {
              displayModeBar: false
            }
          });          
        });
        
      }
      
      function showError(error) {
        return statusDiv.innerHTML = "An error occurred connecting to the EHR";
      }
    </script>

  </body>
</html>


